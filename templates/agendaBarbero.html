{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>Agenda de Turnos</title>
    <link rel="stylesheet" href="{% static 'agendaBarbero.css' %}">
</head>
<body>
    <header class="navbar-container">
        <ul class="navbar-menu">
            <li><a href="http://127.0.0.1:8000" class="back-button">Volver al inicio</a></li>
        </ul>
    </header>
    <main>
        <h1>Agenda de Turnos</h1>
        <form method="get" action="">
            <select name="barbero" id="barbero" onchange="this.form.submit()">
                <option value="">Todos</option>
                {% for barbero in barberos %}
                    <option value="{{ barbero.id }}" {% if barbero.id == barbero_seleccionado %}selected{% endif %}>
                        {{ barbero.nombre }}
                    </option>
                {% endfor %}
            </select>

            <select id="filtro-estado">
                <option value="">Todos</option>
                <option value="PENDIENTE">Pendiente</option>
                <option value="ATENDIDO">Atendido</option>
                <option value="AUSENTE">Ausente</option>
            </select>
        </form>
        <table>
            <thead>
                <tr>
                    <th>Fecha</th>
                    <th>Hora</th>
                    <th>Cliente</th>
                    <th>Barbero</th>
                    <th>Servicio</th>
                    <th>Estado / Acci√≥n</th>
                </tr>
            </thead>
            <tbody>
                {% for turno in turnos %}
                    <tr data-turno-id="{{ turno.id }}">
                        <td>{{ turno.fechaHora|date:"d/m/Y" }}</td>
                        <td>{{ turno.fechaHora|date:"H:i" }}</td>
                        <td>{{ turno.cliente }}</td>
                        <td>{{ turno.barbero }}</td>
                        <td>{{ turno.servicio }}</td>
                        <td class="estado-accion-celda">
                            <button 
                                class="btn-pendiente" 
                                onclick="marcarEstado(this, 'PENDIENTE')">
                                Pendiente
                            </button>
                            <button 
                                class="btn-atendido" 
                                onclick="marcarEstado(this, 'ATENDIDO')">
                                Atendido
                            </button>
                            <button 
                                class="btn-ausente" 
                                onclick="marcarEstado(this, 'AUSENTE')">
                                Ausente
                            </button>
                        </td>
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="6">No hay turnos disponibles.</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </main>
    <script>
        function marcarEstado(botonClickeado, estado) {
            const celdaAccion = botonClickeado.parentNode;
            const fila = botonClickeado.closest('tr');
            const turnoId = fila.getAttribute('data-turno-id');
            const botones = celdaAccion.querySelectorAll('button');
            botones.forEach(btn => btn.classList.remove('seleccionado'));
            botonClickeado.classList.add('seleccionado');
            localStorage.setItem('turno_estado_' + turnoId, estado); 
            filtrarPorEstado(); // Actualiza la visibilidad al cambiar estado
        }

        function cargarEstadosGuardados() {
            const filasTurno = document.querySelectorAll('tbody tr[data-turno-id]');
            filasTurno.forEach(fila => {
                const turnoId = fila.getAttribute('data-turno-id');
                const estadoGuardado = localStorage.getItem('turno_estado_' + turnoId) || 'PENDIENTE';
                
                let botonASeleccionar;
                if (estadoGuardado === 'ATENDIDO') {
                    botonASeleccionar = fila.querySelector('.btn-atendido');
                } else if (estadoGuardado === 'AUSENTE') {
                    botonASeleccionar = fila.querySelector('.btn-ausente');
                } else {
                    botonASeleccionar = fila.querySelector('.btn-pendiente');
                }
                if (botonASeleccionar) {
                    marcarEstado(botonASeleccionar, estadoGuardado); 
                }
            });
        }

        function filtrarPorEstado() {
            const estadoFiltro = document.getElementById('filtro-estado').value;
            const filas = document.querySelectorAll('tbody tr[data-turno-id]');
            
            filas.forEach(fila => {
                const turnoId = fila.getAttribute('data-turno-id');
                const estadoGuardado = localStorage.getItem('turno_estado_' + turnoId) || 'PENDIENTE';

                fila.style.display = (!estadoFiltro || estadoGuardado === estadoFiltro) ? '' : 'none';
            });
        }

        document.getElementById('filtro-estado').addEventListener('change', filtrarPorEstado);
        document.addEventListener('DOMContentLoaded', () => {
            cargarEstadosGuardados();
            filtrarPorEstado();
        });
    </script>
    
</body>
</html>